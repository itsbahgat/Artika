<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: controllers/carts.controller.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: controllers/carts.controller.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const { ConnectionStates } = require("mongoose");
const Carts = require("../models/cart.model");
const Orders = require("../models/order.model");
const { ObjectId } = require('mongodb');

/**
 * Retrieves all carts.
 * @param {Object} request - The request object.
 * @param {Object} response - The response object.
 * @param {Function} next - The next middleware function.
 */
module.exports.GetAllCarts = (request, response, next) => {
  Carts.find({})
    .then(data => {
      response.status(200).json(data);
    })
    .catch(error => {
      next(error);
    });
};

/**
 * Retrieves the cart by customer ID.
 * @param {Object} request - The request object.
 * @param {Object} response - The response object.
 * @param {Function} next - The next middleware function.
 */
module.exports.GetCartByCustId = (request, response, next) => {
  Carts.find({ customerId: request.params.id })
    .populate({
      path: 'items.productId',
      model: 'Product'
    })
    .then(data => {
      response.status(200).json(data);
    })
    .catch(error => {
      next(error);
    });
};

/**
 * Adds an item to the cart.
 * @param {Object} request - The request object.
 * @param {Object} response - The response object.
 * @param {Function} next - The next middleware function.
 */
module.exports.AddItem = async (request, response, next) => {
  let custID = new ObjectId(request.body.customerId);
  let prodID = request.body.productId;

  const cart = await Carts.findOne({ customerId: custID });

  if (!cart) {
    await this.CreateCart(request, response, next);
  } else {
    let item = { productId: prodID, quantity: 1 };
    let foundItem = cart.items.find(i => i.productId == prodID);

    if (!foundItem) {
      const update = { $push: { items: item } };
      const options = { new: true, upsert: true };
      const updatedCart = await Carts.findOneAndUpdate(
        { customerId: custID },
        update,
        options
      );

      response.status(200).json({ message: "new item added", data: updatedCart });
    } else {
      foundItem.quantity++;

      cart.save()
        .then(data => {
          response.status(200).json({ message: "increasing quantity of existing item" });
        })
        .catch(err => next(err));
    }
  }
};

/**
 * Creates a new cart.
 * @param {Object} request - The request object.
 * @param {Object} response - The response object.
 * @param {Function} next - The next middleware function.
 * @returns {Promise}
 */
module.exports.CreateCart = async (request, response, next) => {
  let customerId = new ObjectId(request.body.customerId);
  let productId = new ObjectId(request.body.productId);
  let items = [{ productId }];
  items[0].quantity = 1;
  items[0].productId = new ObjectId(items[0].productId)

  const cart = new Carts({ customerId, items });

  return await cart.save()
    .then(data => {
      response.status(200).json({ message: "added", data: data });
    })
    .catch(err => {
      throw err;
    });
};

/**
 * Removes an item from the cart.
 * @param {Object} request - The request object.
 * @param {Object} response - The response object.
 * @param {Function} next - The next middleware function.
 */
module.exports.RemoveItem = async (request, response, next) => {
  try {
    let { customerId, productId, deleteItem } = request.body;

    const cart = await Carts.findOne({ customerId });

    if (!cart) {
      return response.status(404).json({ message: "There is no cart for this customer" });
    }

    const foundItemIndex = cart.items.findIndex(item => item.productId == productId);

    if (foundItemIndex === -1) {
      return response.status(404).json({ message: "This cart doesn't contain this product" });
    }

    const foundItem = cart.items[foundItemIndex];

    if (!deleteItem &amp;&amp; foundItem.quantity > 1) {
      foundItem.quantity--;
    } else {
      cart.items.splice(foundItemIndex, 1);
    }

    await cart.save();

    return response.status(200).json({ message: "Removed the item from cart" });
  } catch (err) {
    next(err);
  }
};

/**
 * Deletes a cart.
 * @param {Object} request - The request object.
 * @param {Object} response - The response object.
 * @param {Function} next - The next middleware function.
 */
module.exports.DeleteCart = async (request, response, next) => {
  let { customerId, checkout } = request.body;
  customerId = new ObjectId(customerId);
  const cart = await Carts.findOne({ customerId });

  if (!cart) {
    return response.status(404).json({ message: "There is no cart for this customer" });
  }

  if (checkout) {
    const cartWithoutLoading = await Carts.findOne({ customerId });
    const cart = await Carts.findOne({ customerId }).populate({
      path: 'items.productId',
      model: 'Product'
    });

    let totPrice = cart.items.reduce((total, item) => {
      if (item.productId &amp;&amp; item.productId.price) {
        return total + item.quantity * item.productId.price;
      } else {
        return total;
      }
    }, 0);

    const order = new Orders({ customerId, items: cartWithoutLoading.items, status: "pending", total: totPrice });

    await order.save()
      .then(data => {
        response.status(200).json({ message: "add cart to orders with state PENDING", data: data });
      })
      .catch(err => {
        throw err;
      });
  }

  await Carts.deleteOne({ customerId })
    .then(result => {
      if (result.deletedCount === 0) {
        return response.status(404).json({ message: "There is no cart for this customer" });
      }
      response.status(200).json({ message: "Deleted" });
    })
    .catch(err => next(err));
};

module.exports.Carts = Carts;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-Authentication.html">Authentication</a></li><li><a href="module-FileUploader.html">FileUploader</a></li><li><a href="module-ValidationRules.html">ValidationRules</a></li></ul><h3>Global</h3><ul><li><a href="global.html#AddItem">AddItem</a></li><li><a href="global.html#CreateCart">CreateCart</a></li><li><a href="global.html#DeleteCart">DeleteCart</a></li><li><a href="global.html#GetAllCarts">GetAllCarts</a></li><li><a href="global.html#GetAllOrders">GetAllOrders</a></li><li><a href="global.html#GetCartByCustId">GetCartByCustId</a></li><li><a href="global.html#GetOrderByCustId">GetOrderByCustId</a></li><li><a href="global.html#GetOrderByCustIdAndState">GetOrderByCustIdAndState</a></li><li><a href="global.html#GetOrderByState">GetOrderByState</a></li><li><a href="global.html#RemoveItem">RemoveItem</a></li><li><a href="global.html#UpdateOrder">UpdateOrder</a></li><li><a href="global.html#addNewProduct">addNewProduct</a></li><li><a href="global.html#addReviewProductById">addReviewProductById</a></li><li><a href="global.html#createToken">createToken</a></li><li><a href="global.html#deleteCustomerById">deleteCustomerById</a></li><li><a href="global.html#deleteProductById">deleteProductById</a></li><li><a href="global.html#editCustomerById">editCustomerById</a></li><li><a href="global.html#expiryTimeInSeconds">expiryTimeInSeconds</a></li><li><a href="global.html#getAllCategories">getAllCategories</a></li><li><a href="global.html#getAllCustomers">getAllCustomers</a></li><li><a href="global.html#getAllProducts">getAllProducts</a></li><li><a href="global.html#getCustomerById">getCustomerById</a></li><li><a href="global.html#getProductById">getProductById</a></li><li><a href="global.html#getProductsByCategory">getProductsByCategory</a></li><li><a href="global.html#getProductsByTitle">getProductsByTitle</a></li><li><a href="global.html#login">login</a></li><li><a href="global.html#logout">logout</a></li><li><a href="global.html#privateKey">privateKey</a></li><li><a href="global.html#register">register</a></li><li><a href="global.html#tryStripe">tryStripe</a></li><li><a href="global.html#updateProductById">updateProductById</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a> on Wed May 10 2023 15:18:53 GMT+0300 (East Africa Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
